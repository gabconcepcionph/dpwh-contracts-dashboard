<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPWH Contract Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#38bdf8'
                    }
                }
            }
        };
    </script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-brand">DPWH Contract Dashboard</h1>
                    <p class="text-slate-400">Navigate and filter regional contracts.</p>
                </div>
                <div class="flex flex-wrap gap-3 items-center">
                    <div class="flex flex-col">
                        <label class="text-sm text-slate-300" for="dataset-select">Dataset</label>
                        <select id="dataset-select" class="bg-slate-900 border border-slate-700 rounded-md px-3 py-2 text-sm">
                        </select>
                        <p class="text-xs text-slate-500">Source: <a href="https://apps2.dpwh.gov.ph/infra_projects/default.aspx" target="_blank" rel="noopener" class="text-brand underline hover:text-brand/80">DPWH Infra Projects</a> (Date Updated : 9/30/2025)</p>
                    </div>
                    <button id="reload-button" class="px-3 py-2 text-sm font-medium rounded-md bg-brand/20 text-brand border border-brand/40 transition hover:bg-brand/30">
                        Reload Data
                    </button>
                </div>
            </div>
        </header>

        <section class="bg-slate-900 border border-slate-800 rounded-lg p-6 mb-8 shadow-lg shadow-black/20">
            <h2 class="text-xl font-semibold mb-4">Filters</h2>
            <div class="grid gap-6 md:grid-cols-3 lg:grid-cols-3">
                <div class="flex flex-col gap-2">
                    <label for="filter-contractor" class="text-sm text-slate-300">Contractor</label>
                    <input id="filter-contractor" type="text" placeholder="Contractor name" class="bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm">
                </div>
                <div class="flex flex-col gap-2">
                    <label for="filter-status" class="text-sm text-slate-300">Status</label>
                    <select id="filter-status" class="bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="filter-effectivity-month" class="text-sm text-slate-300">Effectivity Month</label>
                    <select id="filter-effectivity-month" class="bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm">
                        <option value="">All Effectivity Months</option>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="mb-8" id="summary-cards">
            <div class="grid gap-4 md:grid-cols-3 hidden" data-state="content">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <p class="text-sm text-slate-400">Active Dataset</p>
                    <p id="summary-dataset" class="text-2xl font-semibold mt-1 text-brand">—</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <p class="text-sm text-slate-400">Projects</p>
                    <p id="summary-projects" class="text-2xl font-semibold mt-1">0</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <p class="text-sm text-slate-400">Total Contract Cost</p>
                    <p id="summary-amount" class="text-2xl font-semibold mt-1">₱0.00</p>
                </div>
            </div>
            <div class="grid gap-4 md:grid-cols-3 animate-pulse" data-state="skeleton">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <div class="h-3.5 w-24 bg-slate-800/80 rounded"></div>
                    <div class="h-8 w-32 bg-slate-800/70 rounded mt-4"></div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <div class="h-3.5 w-20 bg-slate-800/80 rounded"></div>
                    <div class="h-8 w-20 bg-slate-800/70 rounded mt-4"></div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <div class="h-3.5 w-32 bg-slate-800/80 rounded"></div>
                    <div class="h-8 w-36 bg-slate-800/70 rounded mt-4"></div>
                </div>
            </div>
        </section>

        <section class="mb-8" id="extended-summary-cards">
            <div class="grid gap-4 md:grid-cols-5 hidden" data-state="content">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <p class="text-sm text-slate-400">Ongoing Projects</p>
                    <p id="summary-ongoing" class="text-2xl font-semibold mt-1">0</p>
                    <p class="text-sm text-slate-400">Completed Projects</p>
                    <p id="summary-completed" class="text-2xl font-semibold mt-1">0</p>
                    <p class="text-sm text-slate-400">Average Contract Cost</p>
                    <p id="summary-avg-cost" class="text-2xl font-semibold mt-1">₱0.00</p>
                </div>
                <div class="bg-slate-900 h-64 overflow-y-auto col-span-3 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <p class="text-sm text-slate-400">Contractor Ranking (by projects)</p>
                    <ol id="summary-contractors" class="mt-2 space-y-1 list-decimal list-inside text-sm text-slate-300">
                        <li class="text-slate-500">No data</li>
                    </ol>
                </div>
                <div class="bg-slate-900 h-64 overflow-y-auto border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20">
                    <p class="text-sm text-slate-400">Shortest Effectivity → Expiry</p>
                    <p id="summary-shortest-term" class="text-2xl font-semibold mt-1">—</p>
                    <ol id="summary-shortest-term-list" class="mt-3 space-y-1 text-xs text-slate-300 list-decimal list-inside">
                        <li class="text-slate-500">No contract data</li>
                    </ol>
                </div>
            </div>
            <div class="grid gap-4 md:grid-cols-5 animate-pulse" data-state="skeleton">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20 space-y-4">
                    <div class="h-3.5 w-28 bg-slate-800/80 rounded"></div>
                    <div class="h-8 w-20 bg-slate-800/70 rounded"></div>
                    <div class="h-3.5 w-32 bg-slate-800/80 rounded"></div>
                    <div class="h-8 w-24 bg-slate-800/70 rounded"></div>
                    <div class="h-3.5 w-40 bg-slate-800/80 rounded"></div>
                    <div class="h-8 w-28 bg-slate-800/70 rounded"></div>
                </div>
                <div class="bg-slate-900 h-64 overflow-hidden col-span-3 border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20 space-y-3">
                    <div class="h-3.5 w-44 bg-slate-800/80 rounded"></div>
                    <div class="space-y-2">
                        <div class="h-3 w-full bg-slate-800/70 rounded"></div>
                        <div class="h-3 w-11/12 bg-slate-800/70 rounded"></div>
                        <div class="h-3 w-5/6 bg-slate-800/70 rounded"></div>
                        <div class="h-3 w-4/5 bg-slate-800/70 rounded"></div>
                        <div class="h-3 w-3/4 bg-slate-800/70 rounded"></div>
                    </div>
                </div>
                <div class="bg-slate-900 h-64 overflow-hidden border border-slate-800 rounded-xl p-6 shadow-lg shadow-black/20 space-y-4">
                    <div class="h-3.5 w-48 bg-slate-800/80 rounded"></div>
                    <div class="h-7 w-32 bg-slate-800/70 rounded"></div>
                    <div class="space-y-2">
                        <div class="h-3 w-11/12 bg-slate-800/70 rounded"></div>
                        <div class="h-3 w-4/5 bg-slate-800/70 rounded"></div>
                        <div class="h-3 w-2/3 bg-slate-800/70 rounded"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-slate-900 border border-slate-800 rounded-lg p-6 shadow-lg shadow-black/20">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Contracts</h2>
                <span id="results-count" class="text-sm text-slate-400">Loading…</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-800 text-slate-200">
                        <tr class="text-left">
                            <th class="px-3 py-2">Contract ID</th>
                            <th class="px-3 py-2">Description</th>
                            <th class="px-3 py-2">Contractor</th>
                            <th class="px-3 py-2">Implementing Office</th>
                            <th class="px-3 py-2">Contract Cost (₱)</th>
                            <th class="px-3 py-2">Effectivity</th>
                            <th class="px-3 py-2">Expiry</th>
                            <th class="px-3 py-2">Duration (days)</th>
                            <th class="px-3 py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="contracts-body" class="divide-y divide-slate-800">
                        <tr class="animate-pulse">
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/70 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-48 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-40 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-44 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-28 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
                        </tr>
                        <tr class="animate-pulse">
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/70 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-56 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-36 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-40 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
                        </tr>
                        <tr class="animate-pulse">
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/70 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-52 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-44 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-36 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-28 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <template id="table-row-template">
        <tr class="hover:bg-slate-800/50 transition">
            <td class="px-3 py-2 font-semibold text-brand"></td>
            <td class="px-3 py-2 text-slate-200"></td>
            <td class="px-3 py-2 text-slate-200"></td>
            <td class="px-3 py-2 text-slate-300"></td>
            <td class="px-3 py-2 text-slate-200"></td>
            <td class="px-3 py-2 text-slate-200"></td>
            <td class="px-3 py-2 text-slate-200"></td>
            <td class="px-3 py-2 text-slate-200"></td>
            <td class="px-3 py-2 text-slate-200"></td>
        </tr>
    </template>

    <template id="table-skeleton-template">
        <tr class="animate-pulse">
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/70 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-48 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-40 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-44 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-28 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
        </tr>
        <tr class="animate-pulse">
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/70 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-56 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-36 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-40 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
        </tr>
        <tr class="animate-pulse">
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/70 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-52 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-44 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-36 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-28 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-20 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
            <td class="px-3 py-3"><div class="h-3.5 w-24 bg-slate-800/60 rounded"></div></td>
        </tr>
    </template>

    <script>
        $(function () {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            const dataSources = [
                { label: 'Cordillera Administrative Region (CAR)', file: 'car-2025_737.json' },
                { label: 'Region I', file: 'region1-2025_1802.json' },
                { label: 'Region II', file: 'region2-2025_1281.json' },
                { label: 'Region III', file: 'region3-2025_2467.json' },
                { label: 'Region IV-A', file: 'region4a-2025_2091.json' },
                { label: 'Region IV-B', file: 'region4b-2025_958.json' },
                { label: 'Region V', file: 'region5-2025_964.json' },
                { label: 'Region VI', file: 'region6-2025_873.json' },
                { label: 'Region VII', file: 'region7-2025_1304.json' },
                { label: 'Region VIII', file: 'region8-2025_1126.json' },
                { label: 'Region IX', file: 'region9-2025_603.json' },
                { label: 'Region X', file: 'region10-2025_1195.json' },
                { label: 'Region XI', file: 'region11-2025_703.json' },
                { label: 'Region XII', file: 'region12-2025_698.json' },
                { label: 'Region XIII', file: 'region13-2025_782.json' },
                { label: 'Negros Island Region', file: 'negros-2025_913.json' },
                { label: 'National Capital Region', file: 'ncr-2025_1742.json' },
                //{ label: 'NCR (Alt Copy)', file: 'ncr_1742.json' },
                { label: 'All', file: 'all.json' },
            ];

            let allContracts = [];
            let activeSource = null;
            let activeContractIdFilter = null;
            let activeContractorFilter = null;

            const CACHE_PREFIX = 'dpwh-dataset:';
            const ONE_YEAR_MS = 365 * 24 * 60 * 60 * 1000;

            initDatasets();
            initMonthSelectors();
            bindEvents();
            loadDataset(dataSources[0]);

            function initDatasets() {
                const $select = $('#dataset-select');
                dataSources.forEach((source, index) => {
                    const option = $('<option>')
                        .val(source.file)
                        .text(source.label);
                    if (index === 0) {
                        option.prop('selected', true);
                    }
                    $select.append(option);
                });
            }

            function initMonthSelectors() {
                const $effectivity = $('#filter-effectivity-month');
            }

            function bindEvents() {
                const debouncedApplyFilters = debounce(applyFilters, 200);

                $('#dataset-select').on('change', function () {
                    const selected = dataSources.find(ds => ds.file === this.value);
                    if (selected) {
                        loadDataset(selected);
                    }
                });

                $('#reload-button').on('click', function () {
                    if (activeSource) {
                        loadDataset(activeSource, true);
                    }
                });

                $('#filter-contractor').on('input', function () {
                    activeContractorFilter = null;
                    debouncedApplyFilters();
                });

                $('#filter-status, #filter-effectivity-month').on('change', applyFilters);

                $('#summary-shortest-term-list').on('click', 'button[data-contract-id]', function () {
                    const contractId = $(this).data('contractId');
                    if (!contractId) return;
                    if (activeContractIdFilter && contractId.toLowerCase() === activeContractIdFilter.toLowerCase()) {
                        activeContractIdFilter = null;
                    } else {
                        activeContractIdFilter = contractId;
                    }
                    applyFilters();
                });

                $('#summary-contractors').on('click', 'button[data-contractor-name]', function () {
                    const contractorName = $(this).data('contractorName');
                    if (!contractorName) return;

                    if (activeContractorFilter && contractorName === activeContractorFilter) {
                        activeContractorFilter = null;
                        $('#filter-contractor').val('');
                    } else {
                        activeContractorFilter = contractorName;
                        $('#filter-contractor').val(contractorName);
                    }

                    applyFilters();
                });
            }

            function loadDataset(source, forceReload = false) {
                if (!source) return;
                activeSource = source;
                activeContractIdFilter = null;
                activeContractorFilter = null;
                setSummaryLoading(true);
                showTableSkeleton();
                $('#summary-dataset').text(source.label);
                $('#results-count').text('Loading…');

                if (!forceReload) {
                    const cached = readCache(source.file);
                    if (cached) {
                        processDataset(cached);
                        return;
                    }
                }

                fetch(source.file + (forceReload ? `?t=${Date.now()}` : ''))
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load ${source.file}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        saveCache(source.file, data);
                        processDataset(data);
                    })
                    .catch(error => {
                        console.error(error);
                        $('#contracts-body').html(
                            `<tr><td colspan="8" class="px-3 py-6 text-center text-red-400">${error.message}</td></tr>`
                        );
                        $('#results-count').text('0 results');
                        updateSummary([]);
                        setSummaryLoading(false);
                    });
            }

            function setSummaryLoading(isLoading) {
                toggleSectionLoading('#summary-cards', isLoading);
                toggleSectionLoading('#extended-summary-cards', isLoading);
            }

            function toggleSectionLoading(selector, isLoading) {
                const $section = $(selector);
                if (!$section.length) return;
                $section.find('[data-state="skeleton"]').toggleClass('hidden', !isLoading);
                $section.find('[data-state="content"]').toggleClass('hidden', isLoading);
            }

            function showTableSkeleton() {
                const template = document.getElementById('table-skeleton-template');
                const $tbody = $('#contracts-body');
                if (!template || !$tbody.length) return;
                $tbody.empty();
                $tbody.append(template.content.cloneNode(true));
            }
            function processDataset(data) {
                if (!Array.isArray(data)) {
                    throw new Error('Invalid JSON format: expected an array of contracts.');
                }
                allContracts = data;
                populateStatusOptions();
                applyFilters();
                setSummaryLoading(false);
            }

            function getCacheKey(file) {
                return `${CACHE_PREFIX}${file}`;
            }

            function readCache(file) {
                try {
                    const raw = window.localStorage.getItem(getCacheKey(file));
                    if (!raw) return null;
                    const { expiresAt, data } = JSON.parse(raw);
                    if (typeof expiresAt !== 'number' || Date.now() > expiresAt) {
                        window.localStorage.removeItem(getCacheKey(file));
                        return null;
                    }
                    return data;
                } catch (error) {
                    console.warn('Failed to read cached dataset', error);
                    return null;
                }
            }

            function saveCache(file, data) {
                try {
                    const payload = {
                        expiresAt: Date.now() + ONE_YEAR_MS,
                        data
                    };
                    window.localStorage.setItem(getCacheKey(file), JSON.stringify(payload));
                } catch (error) {
                    console.warn('Failed to save dataset cache', error);
                }
            }

            function populateStatusOptions() {
                const statuses = new Set();
                allContracts.forEach(contract => {
                    if (contract.status) {
                        statuses.add(String(contract.status).trim());
                    }
                });
                const sorted = Array.from(statuses).sort((a, b) => a.localeCompare(b));
                const $status = $('#filter-status');
                const current = $status.val();
                $status.empty().append('<option value="">All Statuses</option>');
                sorted.forEach(status => {
                    const option = $('<option>').val(status).text(status);
                    if (status === current) {
                        option.prop('selected', true);
                    }
                    $status.append(option);
                });
            }

            function applyFilters() {
                const contractorQuery = $('#filter-contractor').val().trim().toLowerCase();
                const statusValue = $('#filter-status').val();
                const effectivityMonthValue = $('#filter-effectivity-month').val();
                const monthFilter = effectivityMonthValue === '' ? null : Number(effectivityMonthValue);

                const contractIdFilter = activeContractIdFilter ? activeContractIdFilter.toLowerCase() : null;

                const filtered = allContracts.filter(contract => {
                    const contractIdValue = String(contract.contract_id || '').trim();
                    const contractor = String(contract.contractor || '').toLowerCase();
                    const status = String(contract.status || '').trim();
                    const effectivity = parseMonth(contract.contract_effectivity_date);
                    const expiry = parseMonth(contract.contract_expiry_date);

                    if (contractIdFilter && contractIdValue.toLowerCase() !== contractIdFilter) return false;
                    if (contractorQuery && !contractor.includes(contractorQuery)) return false;
                    if (statusValue && status !== statusValue) return false;
                    if (monthFilter !== null && effectivity !== monthFilter && expiry !== monthFilter) return false;

                    return true;
                });

                renderTable(filtered);
                updateSummary(filtered);
                let resultsLabel = `${filtered.length} result${filtered.length === 1 ? '' : 's'}`;
                if (activeContractIdFilter) {
                    resultsLabel += ` (Contract ID: ${activeContractIdFilter})`;
                }
                if (activeContractorFilter) {
                    resultsLabel += ` (Contractor: ${activeContractorFilter})`;
                }
                $('#results-count').text(resultsLabel);
            }

            function renderTable(contracts) {
                const $tbody = $('#contracts-body');
                $tbody.empty();

                if (!contracts.length) {
                    $tbody.append('<tr><td colspan="8" class="px-3 py-6 text-center text-slate-400">No contracts match the current filters.</td></tr>');
                    return;
                }

                const rowTemplate = document.getElementById('table-row-template');
                contracts.forEach(contract => {
                    const clone = rowTemplate.content.cloneNode(true);
                    const cells = clone.querySelectorAll('td');
                    cells[0].textContent = contract.contract_id || '—';
                    cells[1].textContent = contract.contract_description || '—';
                    cells[2].textContent = contract.contractor || '—';
                    cells[3].textContent = contract.implementing_office || '—';
                    cells[4].textContent = contract.contract_cost_php || '—';
                    cells[5].textContent = contract.contract_effectivity_date || '—';
                    cells[6].textContent = contract.contract_expiry_date || '—';
                    const durationText = formatContractDuration(contract);
                    cells[7].textContent = durationText === null ? '—' : durationText;
                    cells[8].textContent = contract.status || '—';
                    $tbody.append(clone);
                });
            }

            function updateSummary(contracts) {
                const totalProjects = contracts.length;
                const totalCost = contracts.reduce((sum, contract) => sum + parseAmount(contract.contract_cost_php), 0);
                $('#summary-projects').text(totalProjects.toLocaleString());
                const shortAmount = formatShortAmount(totalCost);
                const shortSuffix = shortAmount ? `${shortAmount}` : '';
                $('#summary-amount').text(`${shortSuffix}`);

                const ongoingCount = contracts.reduce((count, contract) => count + (normalizeStatus(contract.status) === 'ongoing' ? 1 : 0), 0);
                const completedCount = contracts.reduce((count, contract) => count + (normalizeStatus(contract.status) === 'completed' ? 1 : 0), 0);
                $('#summary-ongoing').text(ongoingCount.toLocaleString());
                $('#summary-completed').text(completedCount.toLocaleString());

                const averageCost = totalProjects ? totalCost / totalProjects : 0;
                $('#summary-avg-cost').text(`₱${formatCurrency(averageCost)}`);

                const shortestTermResults = contracts.reduce((list, contract) => {
                    const duration = getContractDurationInDays(contract);
                    if (duration === null) return list;
                    list.push({ duration, contract });
                    return list;
                }, [])
                    .sort((a, b) => a.duration - b.duration)
                    .slice(0, 20);

                const shortestTermText = shortestTermResults.length === 0
                    ? '—'
                    : `${shortestTermResults[0].duration.toLocaleString()} day${shortestTermResults[0].duration === 1 ? '' : 's'}`;
                $('#summary-shortest-term').text(shortestTermText);

                const $shortestList = $('#summary-shortest-term-list');
                $shortestList.empty();
                if (shortestTermResults.length === 0) {
                    $shortestList.append('<li class="text-slate-500">No contract data</li>');
                } else {
                    shortestTermResults.forEach(({ duration, contract }) => {
                        const rawContractId = contract.contract_id;
                        const contractId = rawContractId ? String(rawContractId).trim() : '';
                        const displayId = contractId || '—';
                        const itemText = `${displayId} (${duration.toLocaleString()} day${duration === 1 ? '' : 's'})`;

                        if (!contractId) {
                            $shortestList.append(`<li>${itemText}</li>`);
                            return;
                        }

                        const $button = $('<button>', {
                            type: 'button',
                            class: 'text-left px-2 py-1 underline rounded-md transition hover:bg-brand/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/60',
                            'data-contract-id': contractId
                        }).text(itemText);

                        if (activeContractIdFilter && contractId.toLowerCase() === activeContractIdFilter.toLowerCase()) {
                            $button.addClass('bg-brand/30 text-brand');
                        }

                        const $listItem = $('<li>').append($button);
                        $shortestList.append($listItem);
                    });
                }

                const contractorCounts = new Map();
                contracts.forEach(contract => {
                    const name = String(contract.contractor || '').trim();
                    if (!name) return;
                    contractorCounts.set(name, (contractorCounts.get(name) || 0) + 1);
                });
                const sortedContractors = Array.from(contractorCounts.entries())
                    .sort((a, b) => {
                        if (b[1] !== a[1]) return b[1] - a[1];
                        return a[0].localeCompare(b[0]);
                    })
                    //.slice(0, 20);
                const $contractorList = $('#summary-contractors');
                $contractorList.empty();
                if (sortedContractors.length === 0) {
                    $contractorList.append('<li class="text-slate-500">No data</li>');
                } else {
                    sortedContractors.forEach(([name, count]) => {
                        const $button = $('<button>', {
                            type: 'button',
                            class: 'text-left px-2 py-1 underline rounded-md transition hover:bg-brand/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/60',
                            'data-contractor-name': name
                        });

                        $button.append(
                            $('<span>').text(name),
                            ' ',
                            $('<span>', { class: 'text-slate-500' }).text(`(${count.toLocaleString()})`)
                        );

                        if (activeContractorFilter && name === activeContractorFilter) {
                            $button.addClass('bg-brand/30 text-brand');
                        }

                        const $listItem = $('<li>', { class: 'cursor-pointer ' }).append($button);
                        $contractorList.append($listItem);
                    });
                }
            }

            function parseAmount(value) {
                if (value === null || value === undefined) return 0;
                const normalized = String(value).replace(/,/g, '').trim();
                const parsed = Number(normalized);
                return Number.isFinite(parsed) ? parsed : 0;
            }

            function parseMonth(value) {
                if (!value) return null;
                const parsedDate = new Date(value);
                const month = parsedDate.getMonth();
                return Number.isNaN(month) ? null : month;
            }

            function formatCurrency(amount) {
                return amount.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function formatShortAmount(amount) {
                const thresholds = [
                    { value: 1e12, label: 'trillion' },
                    { value: 1e9, label: 'billion' },
                    { value: 1e6, label: 'million' },
                    { value: 1e3, label: 'thousand' },
                ];

                for (const { value, label } of thresholds) {
                    if (amount >= value) {
                        const formatted = (amount / value).toFixed(3);
                        return `${formatted} ${label}`;
                    }
                }

                return amount > 0 ? amount.toFixed(2) : '';
            }

            function getContractDurationInDays(contract) {
                const startRaw = contract.contract_effectivity_date;
                const endRaw = contract.contract_expiry_date;
                if (!startRaw || !endRaw) return null;

                const start = new Date(startRaw);
                const end = new Date(endRaw);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return null;

                const diffMs = end.getTime() - start.getTime();
                if (diffMs < 0) return null;

                return Math.round(diffMs / (1000 * 60 * 60 * 24));
            }

            function formatContractDuration(contract) {
                const startRaw = contract.contract_effectivity_date;
                const endRaw = contract.contract_expiry_date;
                if (!startRaw || !endRaw) return null;

                const start = new Date(startRaw);
                const end = new Date(endRaw);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return null;
                if (end.getTime() < start.getTime()) return null;

                const startUTC = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
                const endUTC = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()));

                let months = (endUTC.getUTCFullYear() - startUTC.getUTCFullYear()) * 12 + (endUTC.getUTCMonth() - startUTC.getUTCMonth());
                let anchor = new Date(Date.UTC(startUTC.getUTCFullYear(), startUTC.getUTCMonth() + months, startUTC.getUTCDate()));

                if (anchor > endUTC) {
                    months -= 1;
                    anchor = new Date(Date.UTC(startUTC.getUTCFullYear(), startUTC.getUTCMonth() + months, startUTC.getUTCDate()));
                }

                const msPerDay = 1000 * 60 * 60 * 24;
                let days = Math.round((endUTC.getTime() - anchor.getTime()) / msPerDay);
                if (days < 0) days = 0;

                if (months <= 0) {
                    return `${days.toLocaleString()} day${days === 1 ? '' : 's'}`;
                }

                if (days <= 0) {
                    return `${months.toLocaleString()} month${months === 1 ? '' : 's'}`;
                }

                return `${months.toLocaleString()} month${months === 1 ? '' : 's'} ${days.toLocaleString()} day${days === 1 ? '' : 's'}`;
            }

            function normalizeStatus(status) {
                if (!status) return '';
                return String(status)
                    .toLowerCase()
                    .replace(/[^a-z]/g, '');
            }

            function debounce(fn, delay) {
                let timer = null;
                return function (...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), delay);
                };
            }
        });
    </script>
</body>

</html>
